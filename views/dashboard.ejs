<%- include('partials/head', { 
    title: title,
    additionalCSS: ['/css/dashboard.css', '/css/components/tables.css']
}) %>

<div class="dashboard-layout">
    <%- include('partials/sidebar') %>
    
    <div class="main-content">
        <%- include('partials/header', { 
            pageTitle: pageTitle,
            pageSubtitle: pageSubtitle
        }) %>
        
        <div class="content-area">
            <!-- Navigation Tabs -->
            <div class="dashboard-tabs">
                <button class="tab-btn active" data-tab="overview">Overview</button>
                <button class="tab-btn" data-tab="partners">Partners</button>
                <button class="tab-btn" data-tab="financial">Financial</button>
                <button class="tab-btn" data-tab="external">External</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <div class="stat-number" id="total-partners"><%= data.masterRegister.length %></div>
                            <div class="stat-label">Total Partners</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <div class="stat-number" id="signed-partners">
                                <%= data.masterRegister.filter(p => p.status === 'Signed' || p['Contract Status'] === 'Signed').length %>
                            </div>
                            <div class="stat-label">Signed Contracts</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-info">
                            <div class="stat-number" id="contracting-partners">
                                <%= data.masterRegister.filter(p => p.status === 'In Contracting' || p['Contract Status'] === 'In Contracting').length %>
                            </div>
                            <div class="stat-label">In Contracting</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üåê</div>
                        <div class="stat-info">
                            <div class="stat-number" id="external-partners"><%= data.externalPartners.length %></div>
                            <div class="stat-label">External Partners</div>
                        </div>
                    </div>
                </div>
                
                <div class="charts-section">
                    <div class="chart-container">
                        <h3>Contract Status Distribution</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Partners by Region</h3>
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Partners Tab -->
            <div id="partners" class="tab-content">
                <div class="table-container">
                    <h2>Master Register</h2>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner ID</th>
                                    <th>Partner Name</th>
                                    <th>Status</th>
                                    <th>Region</th>
                                    <th>Key Personnel</th>
                                    <th>Task Order Price (Y1)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.masterRegister.forEach(partner => { %>
                                <tr>
                                    <td><%= partner.id || partner['Partner ID'] || 'N/A' %></td>
                                    <td><%= partner.name || partner['Partner Name'] || 'Unnamed Partner' %></td>
                                    <td>
                                        <span class="status-badge <%= (partner.status === 'Signed' || partner['Contract Status'] === 'Signed') ? 'signed' : 'contracting' %>">
                                            <%= partner.status || partner['Contract Status'] || 'Unknown' %>
                                        </span>
                                    </td>
                                    <td><%= partner.regions ? (Array.isArray(partner.regions) ? partner.regions.join(', ') : partner.regions) : (partner['Regions of Operation'] || 'N/A') %></td>
                                    <td><%= partner.keyPersonnel || partner['Key Personnel'] || 'N/A' %></td>
                                    <td><%= partner.taskOrderPrice || partner['Task Order Price (Y1)'] || 'N/A' %></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Financial Tab -->
            <div id="financial" class="tab-content">
                <div class="table-container">
                    <h2>Financial Summary</h2>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner ID</th>
                                    <th>Partner Name</th>
                                    <th>Total Task Order Price</th>
                                    <th>Q1 Report</th>
                                    <th>Q2 Report</th>
                                    <th>Utilization Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.financialSummary.forEach(finance => { %>
                                <tr>
                                    <td><%= finance.partnerId || finance['Partner ID'] || 'N/A' %></td>
                                    <td><%= finance.partnerName || finance['Partner Name'] || 'N/A' %></td>
                                    <td><%= finance.contractValue || finance['Total Task Order Price'] || '-' %></td>
                                    <td>
                                        <span class="status-badge <%= (finance['Q1 Report Received'] === 'Yes') ? 'approved' : 'pending' %>">
                                            <%= finance['Q1 Report Received'] || 'Pending' %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge <%= (finance['Q2 Report Received'] === 'Yes') ? 'approved' : 'pending' %>">
                                            <%= finance['Q2 Report Received'] || 'Pending' %>
                                        </span>
                                    </td>
                                    <td><%= finance.utilizationRate ? (finance.utilizationRate * 100) + '%' : (finance['Utilization Rate'] ? (finance['Utilization Rate'] * 100) + '%' : '-') %></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- External Partners Tab -->
            <div id="external" class="tab-content">
                <div class="table-container">
                    <h2>External Partners</h2>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner Name</th>
                                    <th>Key Contact</th>
                                    <th>Current Stage</th>
                                    <th>Status</th>
                                    <th>Responsible Person</th>
                                    <th>Deadline</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.externalPartners.forEach(partner => { %>
                                <tr>
                                    <td><%= partner.name || partner['Partner Name'] || 'N/A' %></td>
                                    <td><%= partner.contact || partner['Key Contact & Details'] || '-' %></td>
                                    <td><%= partner.stage || partner['Current Stage'] || '-' %></td>
                                    <td>
                                        <span class="status-badge <%= (partner.status === 'On Track' || partner['Status'] === 'On Track') ? 'approved' : 'pending' %>">
                                            <%= partner.status || partner['Status'] || 'Unknown' %>
                                        </span>
                                    </td>
                                    <td><%= partner.responsible || partner['Responsible Person(s)'] || '-' %></td>
                                    <td><%= partner.deadline || partner['Deadline'] || '-' %></td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer', { additionalJS: ['/js/dashboard.js'] }) %>

<script>
    // Pass data to frontend JavaScript
    window.dashboardData = <%- JSON.stringify(data) %>;
    window.user = <%- JSON.stringify(user) %>;
</script>