<%- include('partials/head', { 
    title: 'Key Personnel Directory - Partner Dashboard',
    additionalCSS: ['/css/key-personnel.css', '/css/components/tables.css']
}) %>

<div class="dashboard-layout">
    <%- include('partials/sidebar') %>
    
    <div class="main-content">
        <div class="content-area">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <h1 class="page-title">Key Personnel Directory</h1>
                    <p class="page-subtitle">Contact management and partner communication</p>
                </div>
                <div class="page-actions">
                    <button class="btn btn-secondary" id="refreshPersonnelBtn">
                        <span class="icon">‚Üª</span>
                        <span>Refresh</span>
                    </button>
                    <button class="btn btn-secondary" id="exportPersonnelBtn">
                        <span class="icon">üì•</span>
                        <span>Export</span>
                    </button>
                    <a href="/forms/personnel" class="btn btn-primary">
                        <span class="icon">‚ûï</span>
                        <span>Add Personnel</span>
                    </a>
                </div>
            </div>

            <!-- Statistics Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalPersonnel">0</div>
                            <div class="stat-label">Total Personnel</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üè¢</div>
                        <div class="stat-info">
                            <div class="stat-value" id="activePartners">0</div>
                            <div class="stat-label">Active Partners</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-info">
                            <div class="stat-value" id="keyContacts">0</div>
                            <div class="stat-label">Key Contacts</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì±</div>
                        <div class="stat-info">
                            <div class="stat-value" id="verifiedContacts">0</div>
                            <div class="stat-label">Verified Contacts</div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="search-filter-section">
                    <div class="search-filters">
                        <div class="search-group">
                            <div class="search-input-wrapper">
                                <input 
                                    type="text" 
                                    id="personnelSearch" 
                                    placeholder="Search personnel..." 
                                    class="search-input"
                                >
                                <button class="search-btn">üîç</button>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <select id="partnerPersonnelFilter" class="filter-select">
                                <option value="">All Partners</option>
                                <% if (locals.data && locals.data.partners) { %>
                                    <% data.partners.forEach(partner => { %>
                                        <option value="<%= partner.id %>"><%= partner.partnerName || partner.name %></option>
                                    <% }); %>
                                <% } %>
                                <% if (locals.data && locals.data.externalPartners) { %>
                                    <% data.externalPartners.forEach(partner => { %>
                                        <option value="<%= partner.id %>"><%= partner.partnerName || partner.name %> (External)</option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select id="rolePersonnelFilter" class="filter-select">
                                <option value="">All Roles</option>
                                <% if (locals.data && locals.data.personnel) { %>
                                    <% 
                                    const uniqueRoles = [...new Set(data.personnel.map(p => p.jobTitle).filter(role => role))];
                                    uniqueRoles.sort().forEach(role => { 
                                    %>
                                        <option value="<%= role %>"><%= role %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <select id="statusPersonnelFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="On Leave">On Leave</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Terminated">Terminated</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="quick-search">
                        <input 
                            type="text" 
                            id="quickPersonnelSearch" 
                            placeholder="Quick search..." 
                            class="quick-search-input"
                        >
                    </div>
                </div>

                <!-- Personnel Table -->
                <div class="table-container">
                    <table class="data-table" id="personnelTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="partnerId">Partner ID</th>
                                <th class="sortable" data-sort="partnerName">Partner Name</th>
                                <th class="sortable" data-sort="name">Full Name</th>
                                <th class="sortable" data-sort="role">Role/Position</th>
                                <th class="sortable" data-sort="department">Department</th>
                                <th class="sortable" data-sort="email">Email</th>
                                <th class="sortable" data-sort="phone">Phone</th>
                                <th class="sortable" data-sort="status">Status</th>
                                <th class="sortable" data-sort="lastContact">Last Contact</th>
                                <th class="actions-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                          <% if (typeof personnel !== 'undefined' && Array.isArray(personnel) && personnel.length) { %>
                            <% personnel.forEach(function(p) { %>
                              <tr>
                                <td><%= p.partnerId || p.partner?.id || '-' %></td>
                                <td><%= p.partnerName || p.partner?.partnerName || '-' %></td>
                                <td><%= p.fullName || p.name || '-' %></td>
                                <td><%= p.jobTitle || p.role || '-' %></td>
                                <td><%= p.department || '-' %></td>
                                <td><%= p.emailAddress || p.email || '-' %></td>
                                <td><%= p.phoneNumber || p.phone || '-' %></td>
                                <td><%= p.workStatus || p.status || 'Unknown' %></td>
                                <td><%= p.lastContact || (p.updatedAt ? p.updatedAt.toISOString() : '-') %></td>
                                <td class="actions-cell">
                                  <a href="/personnel/<%= p.id %>" class="action-btn view-btn">View</a>
                                  <a href="/forms/personnel/<%= p.id %>/edit" class="action-btn edit">Edit</a>
                                </td>
                              </tr>
                            <% }); %>
                          <% } else { %>
                            <!-- keep JS-only fallback row -->
                            <!-- Data will be populated by client JS if available -->
                          <% } %>
                        </tbody>
                    </table>
                </div>

                <!-- Table Footer with Pagination and Summary -->
                <div class="table-footer">
                    <div class="footer-info">
                        <span>Showing <strong id="showingPersonnelCount">0</strong> of <strong id="totalPersonnelCount">0</strong> personnel</span>
                        <span class="separator">‚Ä¢</span>
                        <span>Active: <strong id="footerActiveCount">0</strong></span>
                        <span class="separator">‚Ä¢</span>
                        <span>Key Contacts: <strong id="footerKeyContactCount">0</strong></span>
                        <span class="separator">‚Ä¢</span>
                        <span>Response Rate: <strong id="footerResponseRate">0%</strong></span>
                    </div>
                    
                    <div class="footer-actions">
                        <button class="btn btn-sm btn-secondary" id="selectAllPersonnelBtn">Select All</button>
                        <button class="btn btn-sm btn-secondary" id="clearSelectionBtn">Clear</button>
                        <button class="btn btn-sm btn-primary" id="bulkExportBtn">Bulk Export</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <%- include('partials/footer') %>
    
    <!-- Pass data to JavaScript -->
    <% if (locals.jsData) { %>
        <script>
            window.personnelData = <%- JSON.stringify(jsData.personnel || []) %>;
            window.partnersData = <%- JSON.stringify(jsData.partners || []) %>;
            window.statsData = <%- JSON.stringify(jsData.stats || {}) %>;
        </script>
    <% } %>

    <!-- include client filter/render script -->
    <script src="/js/views/key-personnel.js"></script>

    <% if (locals.additionalJS) { %>
        <% additionalJS.forEach(function(js) { %>
            <script src="<%= js %>"></script>
        <% }); %>
    <% } %>
        </div>
    </div>
</div>